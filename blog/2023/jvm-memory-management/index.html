<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>JVM memory management | Zihe Huang</title> <meta name="author" content="Zihe Huang"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700%7CRoboto+Slab:100,300,400,500,700%7CMaterial+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://zihe33huang.github.io/blog/2023/jvm-memory-management/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Zihe </span>Huang</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching</a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/publications/">publications</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/projects/">projects</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">JVM memory management</h1> <p class="post-meta">February 26, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/jvm"> <i class="fas fa-hashtag fa-sm"></i> jvm</a>   </p> </header> <article class="post-content"> <h1 id="what-is-memory-management-in-java">What is memory management in Java</h1> <ul> <li>In C, C++, we programers need to keep watch of memory allocation.</li> <li>In Java, Garbage Collector has the duty of memory deallocation handling and it runs automatically.</li> </ul> <h1 id="jvm-memory-structure">JVM Memory Structure</h1> <ul> <li> <p><img src="images/image-20230227005117988.png" alt="image-20230227005117988" style="zoom:50%;"></p> </li> <li>https://seagence.com/blog/memory-management-java/</li> <li>https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.5.4</li> <li>https://www.yuque.com/u21195183/jvm/nbkm46</li> </ul> <h4 id="heap-memory">Heap Memory</h4> <ul> <li>Shared runtime data area that can be allocated to all objects and arrays, including class objects.</li> <li>VM options to configure head size: <ul> <li>Maximum Java heap size: -Xmx</li> <li>Initial Java heap size: -Xms</li> </ul> </li> </ul> <h4 id="jvm-stack-area">JVM Stack Area</h4> <ul> <li> <p>Private.</p> </li> <li>A stack is created simultaneously with the creation of a thread.</li> <li> <font color="red">**Fixed Size**</font> <p>. If the computation in a thread requires a larger Java Virtual Machine stack than is permitted, the Java Virtual Machine throws a <code class="language-plaintext highlighter-rouge">StackOverflowError</code></p> </li> <li> <font color="red">**Auto expanded size**</font> <p>. If Java Virtual Machine stacks can be dynamically expanded, and expansion is attempted but insufficient memory can be made available to effect the expansion, or if insufficient memory can be made available to create the initial Java Virtual Machine stack for a new thread, the Java Virtual Machine throws an <code class="language-plaintext highlighter-rouge">OutOfMemoryError</code>.</p> </li> </ul> <h5 id="stack-frame-contains">Stack Frame contains</h5> <ul> <li>Local Variable array 本地变量表</li> <li>Frame Data</li> <li>Operand Stack 操作数栈</li> <li> <p>Dynamic linking</p> </li> <li>The sizes of LVA, FD and OS are <font color="red">**determined at the compile time** </font> </li> <li>每个线程只能有一个活动栈帧（current frame, active frame) ，对应着当前正在执行的那个方法.</li> </ul> <h5 id="does-gc-involve-jvm-stack-area">Does GC involve JVM Stack Area?</h5> <ul> <li>No. The memory on the stack contains <strong>method-parameters</strong> and <strong>local variables</strong> (to be precise: the references for objects and variables itself for primitive types). <strong>The memory will be automatically removed if you leave the method</strong>.</li> </ul> <h5 id="is-local-variables-thread-safe">Is local variables thread safe?</h5> <ul> <li> <p>Every thread has its own JVM stack and never share its stack with other thread.</p> </li> <li> <p>But local references to objects are a bit different. The reference itself is not shared. The object referenced however, is not stored in each threads’s local stack. All objects are stored in the shared heap.</p> <p><strong>①</strong> If an object created locally never escapes the method it was created in, it is thread safe.</p> <p><strong>②</strong> But if it escapes from the method, we need to consider thread safe.</p> </li> </ul> <h4 id="program-counter-pc-register">Program counter (PC) register</h4> <ul> <li> <p>Private</p> </li> <li> <p>Storing the address of the next instruction.</p> </li> <li> <p>No GC and OOM</p> </li> <li> <p>Why we need it</p> <ul> <li> <p>There are many threads in JVM, <font color="red">context switch </font>will frequently happen, with PC register, CPU know where to execute.</p> </li> <li>Context Switch: In computing, a context <em>switch</em> is the process of storing the state of a process or <em>thread</em>, so that it can be restored and resume execution at a later point.</li> <li> </li> </ul> </li> </ul> <h4 id="method-area">Method Area</h4> <ul> <li>Create as JVM starts up.</li> <li>The size of method area determine how many classes can be stored, if there are too many classes in system, memory can not be made available to satisfy memory allocation, <strong>JVM will throws OOM</strong> <ul> <li>加载大量第三方jar包。 Tomcat部署工程过多。 大量动态的生成反射类。</li> </ul> </li> <li>元空间: metaspace 永久代: PermGen Permanent Generation <ul> <li>Diff: https://www.baeldung.com/java-permgen-metaspace</li> </ul> </li> </ul> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Zihe Huang. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>